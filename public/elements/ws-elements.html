<dom-module id="ws-ajax">
	<script>
		Polymer({
			is: "ws-ajax",
			properties: {
				url: {
					type: String
				},
				params: {
					type: Object,
					value: null
				},
				data: {
					type: Object,
					notify: true
				},
				wait: {
					type: Boolean,
					value: false
				}
			},
			created: function() {
				this.done = false;
			},
			attached: function() {
				if (!this.wait) this.execute();
			},
			execute: function() {
				if (this.done) return;
				this.done = true;
				var self = this;
				$.get(this.url, this.params, function(data) {
					self.data = data;
				}, "json");
			}
		});
	</script>
</dom-module>

<dom-module id="ws-img">
	<template>
		<style>
			:host {
				display: inline-block;
				background: #888;
				border-radius: 10px;
				overflow: hidden;
			}
			img {
				width: 100%;
				height: 100%;
			}
			:host([fade]) img {
				opacity: 0.5;
			}
		</style>
		<img src="{{url}}">
	</template>
	<script>
		Polymer({
			is: "ws-img",
			properties: {
				card: {
					type: String
				},
				url: {
					type: String,
					computed: "computeURL(card)"
				}
			},
			computeURL: function(card) {
				return "http://loki.cpfk.net/card/" + card.replace(/\/|-/g, "_").toLowerCase() + ".gif";
			}
		});
	</script>
</dom-module>

<dom-module id="ws-ext-cards">
	<template>
		<style>
			#cards {
				display: flex;
				flex-wrap: wrap;
				padding: 6px 0;
			}

			:host {
				display: flex;
				justify-content: center;
				margin-right: -10px;
			}
		</style>
		<ws-ajax url="/api/extcards" params="{{loadParams}}" data="{{cards}}"></ws-ajax>
		<div id="cards">
			<template is="dom-repeat" items="{{cards}}">
				<ws-ext-card data="{{item}}" title$="{{item.name}}"></ws-ext-card>
			</template>
		</div>
	</template>
	<script>
		Polymer({
			is: "ws-ext-cards",
			properties: {
				ext: {
					type: Number
				},
				loadParams: {
					type: Object,
					computed: "buildLoadParams(ext)"
				}
			},
			buildLoadParams: function(ext) {
				return {id: ext};
			},
			load: function() {
				console.log(this.ext);
			}
		});
	</script>
</dom-module>

<dom-module id="ws-ext-card">
	<template>
		<style>
			:host {
				padding: 5px 10px 5px 0;
				position: relative;
				font-size: 12px;
				overflow: hidden;
				line-height: 0;
			}

			ws-img {
				width: 112px;
				height: 155px;
				transition: all ease-out .25s;
				border: 2px solid;
			}

			.corner {
				position: absolute;
				top: 17px;
				left: -19px;
				transform: rotate(-45deg);
				width: 80px;
				border-bottom: 20px solid #ADFF2F;
				border-left: 20px solid transparent;
				border-right: 20px solid transparent;
				line-height: 1.5em;
				color: #fff;
			}

			#wrapper[quantity="0"] .corner {
				opacity: 0;
				transform: scale(1.4) rotate(-45deg);
			}

			.corner div {
				position: absolute;
				width: 100%;
				font-size: 14px;
				font-weight: 600;
				text-align: center;
			}

			.overlay {
				position: absolute;
				bottom: 5px;
				left: 0;
				right: 10px;
				text-align: center;
				padding: 2px;
				border-bottom-left-radius: 10px;
				border-bottom-right-radius: 10px;
				line-height: 1.5em;
				color: #fff;
			}

			.action {
				position: absolute;
				top: 5px;
				right: 10px;
				border-top-right-radius: 10px;
				border-bottom-left-radius: 10px;
				overflow: hidden;
				width: 30px;
				height: 30px;
			}

			.action .rarity {
				left: 0;
			}

			#wrapper:hover .action .rarity {
				opacity: 0;
				left: -30px;
			}

			.action a {
				opacity: 0;
				left: 30px;
				top: 0;
				text-decoration: none;
			}

			#wrapper:hover .action a {
				opacity: 1;
				left: 0;
			}

			.action .rarity, .action a {
				position: absolute;
				color: #fff;
				font-size: 12px;
				line-height: 30px;
				width: 100%;
				text-align: center;
				transition: all ease-out .4s;
			}

			#wrapper[color="Yellow"] ws-img { border-color: rgba(239, 210, 10, 0.9); }
			#wrapper[color="Yellow"] .corner { border-bottom-color: rgba(239, 210, 10, 1); }
			#wrapper[color="Yellow"] .overlay, #wrapper[color="Yellow"] .action { background: rgba(239, 210, 10, 0.9); }

			#wrapper[color="Red"] ws-img { border-color: rgba(197, 58, 28, 0.9); }
			#wrapper[color="Red"] .corner { border-bottom-color: rgba(237, 75, 38, 1); }
			#wrapper[color="Red"] .overlay, #wrapper[color="Red"] .action { background: rgba(197, 58, 28, 0.9); }

			#wrapper[color="Green"] ws-img { border-color: rgba(91, 152, 67, 0.9); }
			#wrapper[color="Green"] .corner { border-bottom-color: rgba(110, 194, 76, 1); }
			#wrapper[color="Green"] .overlay, #wrapper[color="Green"] .action { background: rgba(91, 152, 67, 0.9); }

			#wrapper[color="Blue"] ws-img { border-color: rgba(61, 129, 165, 0.9); }
			#wrapper[color="Blue"] .corner { border-bottom-color: rgba(72, 157, 203, 1); }
			#wrapper[color="Blue"] .overlay, #wrapper[color="Blue"] .action { background: rgba(61, 129, 165, 0.9); }
		</style>
		<div id="wrapper" quantity$="{{data.quantity}}" color$="{{data.color}}">
			<ws-img card="{{data.id}}" fade$="{{!data.quantity}}"></ws-img>
			<div class="overlay">{{data.id}}</div>
			<div class="action">
				<a id="details" href="#" class="glyphicon glyphicon-search"></a>
				<span class="rarity">{{data.rarity}}</span>
			</div>
			<div class="corner">
				<div>{{data.quantity}}</div>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: "ws-ext-card",
			properties: {
				data: {
					type: Object
				}
			},
			listeners: {
				'click': 'clicked',
				'contextmenu': 'clicked',
				'details.click': 'detailsClicked'
			},
			clicked: function(e) {
				var change = 0;
				switch (e.button) {
					case 2: change = -1; break;
					default: change = +1; break;
				}
				e.preventDefault();
				this.set("data.quantity", Math.max(0, this.data.quantity + change));
			},
			detailsClicked: function(e) {
				console.log("/cards/");
				e.stopImmediatePropagation();
			}
		});
	</script>
</dom-module>
